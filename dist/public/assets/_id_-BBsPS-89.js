import{u as e,e as s,r as a,n as r,t as n,f as i,j as l,L as d,al as t,B as o,k as c,aA as m,aT as u,ab as h,aB as x,aC as j,aD as p,aE as w,aF as f,aG as g,aH as v,aU as y,aV as N,aW as b,aX as S,C as P,a as E,b as C,g as F,c as U,F as A,w as I,x as T,y as k,z as q,I as D,G as V,S as K,J as L,K as Q,N as G,O as $,Q as z,aP as B,aQ as O,X as J,a6 as R,d as X,Y as H,Z as W,aR as Y,aS as Z,_}from"./index-C_9oFDzq.js";const M=H({fullName:_().min(2,"Full name must be at least 2 characters"),email:_().email("Email must be a valid email address"),role:Z(["admin","agent","user"]),companyId:Y().optional(),isSuperAdmin:W().default(!1)}),ee=H({newPassword:_().min(6,"Password must be at least 6 characters"),confirmPassword:_()}).refine((e=>e.newPassword===e.confirmPassword),{message:"Passwords don't match",path:["confirmPassword"]});function se(){var H;const{user:W,isLoading:Y}=e(),{toast:Z}=s(),[_,se]=a.useState(null),[ae,re]=a.useState(!1);a.useEffect((()=>{const e=window.location.pathname,s=parseInt(e.split("/").pop()||"");isNaN(s)||se(s)}),[]),a.useEffect((()=>{Y||!W||W.isSuperAdmin||(window.location.href="/")}),[W,Y]);const{data:ne,isLoading:ie}=r({queryKey:["/api/admin/users",_],queryFn:async()=>{if(!_)throw new Error("User ID is required");const e=await X("GET",`/api/admin/users/${_}`);if(!e.ok)throw new Error("Failed to fetch user");return e.json()},enabled:!!_&&!!(null==W?void 0:W.isSuperAdmin)}),{data:le,isLoading:de}=r({queryKey:["/api/admin/companies"],queryFn:async()=>{const e=await X("GET","/api/admin/companies");if(!e.ok)throw new Error("Failed to fetch companies");return e.json()},enabled:!!(null==W?void 0:W.isSuperAdmin)}),te=(null==le?void 0:le.filter((e=>e.active)))||[],oe=n({resolver:J(M),defaultValues:{fullName:"",email:"",role:"agent",isSuperAdmin:!1}}),ce=n({resolver:J(ee),defaultValues:{newPassword:"",confirmPassword:""}});a.useEffect((()=>{ne&&oe.reset({fullName:ne.fullName,email:ne.email,role:ne.role,companyId:ne.companyId||void 0,isSuperAdmin:ne.isSuperAdmin})}),[ne,oe]);const me=i({mutationFn:async e=>{if(!_)throw new Error("User ID is required");const s=await X("PUT",`/api/admin/users/${_}`,e);if(!s.ok){const e=await s.json();throw new Error(e.message||"Failed to update user")}return s.json()},onSuccess:()=>{R.invalidateQueries({queryKey:["/api/admin/users"]}),R.invalidateQueries({queryKey:["/api/admin/users",_]}),Z({title:"User Updated",description:"The user has been updated successfully"})},onError:e=>{Z({title:"Error",description:e.message||"Failed to update user",variant:"destructive"})}}),ue=i({mutationFn:async e=>{if(!_)throw new Error("User ID is required");const s=await X("POST",`/api/admin/users/${_}/change-password`,e);if(!s.ok){const e=await s.json();throw new Error(e.message||"Failed to change password")}return s.json()},onSuccess:()=>{ce.reset(),Z({title:"Password Changed",description:"The user's password has been changed successfully"})},onError:e=>{Z({title:"Error",description:e.message||"Failed to change password",variant:"destructive"})}}),he=i({mutationFn:async()=>{if(!_)throw new Error("User ID is required");const e=await X("DELETE",`/api/admin/users/${_}`);if(!e.ok){const s=await e.json();throw new Error(s.message||"Failed to delete user")}return e.json()},onSuccess:()=>{R.invalidateQueries({queryKey:["/api/admin/users"]}),Z({title:"User Deleted",description:"The user has been deleted successfully"}),setTimeout((()=>{window.location.href="/admin/users"}),1500)},onError:e=>{Z({title:"Error",description:e.message||"Failed to delete user",variant:"destructive"})}});return Y||ie?l.jsx("div",{className:"flex items-center justify-center min-h-screen",children:l.jsx(d,{className:"h-8 w-8 animate-spin text-primary"})}):(null==W?void 0:W.isSuperAdmin)&&ne?l.jsx(t,{children:l.jsxs("div",{className:"p-6",children:[l.jsxs("div",{className:"flex items-center justify-between mb-6",children:[l.jsxs("div",{className:"flex items-center",children:[l.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>window.location.href="/admin/users",className:"mr-4",children:[l.jsx(c,{className:"h-4 w-4 mr-2"}),"Back to Users"]}),l.jsxs("h1",{className:"text-2xl",children:["Edit User: ",ne.fullName]})]}),l.jsxs(m,{open:ae,onOpenChange:re,children:[l.jsx(u,{asChild:!0,children:l.jsxs(o,{variant:"destructive",size:"sm",children:[l.jsx(h,{className:"h-4 w-4 mr-2"}),"Delete User"]})}),l.jsxs(x,{children:[l.jsxs(j,{children:[l.jsx(p,{children:"Are you sure?"}),l.jsx(w,{children:"This action cannot be undone. This will permanently delete the user account and remove their data from our servers."})]}),l.jsxs(f,{children:[l.jsx(g,{children:"Cancel"}),l.jsx(v,{onClick:()=>{he.mutate(),re(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Delete"})]})]})]})]}),l.jsxs(y,{defaultValue:"profile",className:"max-w-2xl mx-auto",children:[l.jsxs(N,{className:"grid w-full grid-cols-2",children:[l.jsx(b,{value:"profile",children:"Profile Information"}),l.jsx(b,{value:"security",children:"Security"})]}),l.jsx(S,{value:"profile",children:l.jsxs(P,{children:[l.jsxs(E,{children:[l.jsx(C,{children:"User Profile"}),l.jsx(F,{children:"Update the user's profile information"})]}),l.jsx(U,{children:l.jsx(A,{...oe,children:l.jsxs("form",{onSubmit:oe.handleSubmit((e=>{me.mutate(e)})),className:"space-y-6",children:[l.jsx(I,{control:oe.control,name:"fullName",render:({field:e})=>l.jsxs(T,{children:[l.jsx(k,{children:"Full Name"}),l.jsx(q,{children:l.jsx(D,{placeholder:"John Doe",...e})}),l.jsx(V,{})]})}),l.jsx(I,{control:oe.control,name:"email",render:({field:e})=>l.jsxs(T,{children:[l.jsx(k,{children:"Email"}),l.jsx(q,{children:l.jsx(D,{placeholder:"user@example.com",...e})}),l.jsx(V,{})]})}),l.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[l.jsx(I,{control:oe.control,name:"role",render:({field:e})=>l.jsxs(T,{children:[l.jsx(k,{children:"Role"}),l.jsxs(K,{onValueChange:e.onChange,defaultValue:e.value,children:[l.jsx(q,{children:l.jsx(L,{children:l.jsx(Q,{placeholder:"Select a role"})})}),l.jsxs(G,{children:[l.jsx($,{value:"admin",children:"Admin"}),l.jsx($,{value:"agent",children:"Agent"}),l.jsx($,{value:"user",children:"User"})]})]}),l.jsx(V,{})]})}),l.jsxs(T,{children:[l.jsx(k,{children:"Company"}),l.jsxs(K,{onValueChange:e=>{oe.setValue("companyId",parseInt(e))},disabled:de||oe.watch("isSuperAdmin"),defaultValue:null==(H=ne.companyId)?void 0:H.toString(),children:[l.jsx(q,{children:l.jsx(L,{children:l.jsx(Q,{placeholder:"Select a company"})})}),l.jsx(G,{children:te.map((e=>l.jsx($,{value:e.id.toString(),children:e.name},e.id)))})]}),l.jsx(V,{})]})]}),l.jsx(I,{control:oe.control,name:"isSuperAdmin",render:({field:e})=>l.jsxs(T,{className:"flex flex-row items-center justify-between rounded-lg border p-4",children:[l.jsxs("div",{className:"space-y-0.5",children:[l.jsx(k,{className:"text-base",children:"Super Admin"}),l.jsx(z,{children:"Super admins have access to all system features and settings"})]}),l.jsx(q,{children:l.jsx(B,{checked:e.value,onCheckedChange:s=>{e.onChange(s),s&&oe.setValue("companyId",void 0)}})})]})}),l.jsx(o,{type:"submit",className:"btn-brand-primary",disabled:me.isPending,children:me.isPending?l.jsxs(l.Fragment,{children:[l.jsx(d,{className:"mr-2 h-4 w-4 animate-spin"}),"Updating User..."]}):l.jsxs(l.Fragment,{children:[l.jsx(O,{className:"mr-2 h-4 w-4"}),"Save Changes"]})})]})})})]})}),l.jsx(S,{value:"security",children:l.jsxs(P,{children:[l.jsxs(E,{children:[l.jsx(C,{children:"Change Password"}),l.jsx(F,{children:"Update the user's password"})]}),l.jsx(U,{children:l.jsx(A,{...ce,children:l.jsxs("form",{onSubmit:ce.handleSubmit((e=>{ue.mutate({newPassword:e.newPassword})})),className:"space-y-6",children:[l.jsx(I,{control:ce.control,name:"newPassword",render:({field:e})=>l.jsxs(T,{children:[l.jsx(k,{children:"New Password"}),l.jsx(q,{children:l.jsx(D,{type:"password",placeholder:"••••••••",...e})}),l.jsx(V,{})]})}),l.jsx(I,{control:ce.control,name:"confirmPassword",render:({field:e})=>l.jsxs(T,{children:[l.jsx(k,{children:"Confirm New Password"}),l.jsx(q,{children:l.jsx(D,{type:"password",placeholder:"••••••••",...e})}),l.jsx(V,{})]})}),l.jsx(o,{type:"submit",className:"btn-brand-primary",disabled:ue.isPending,children:ue.isPending?l.jsxs(l.Fragment,{children:[l.jsx(d,{className:"mr-2 h-4 w-4 animate-spin"}),"Changing Password..."]}):"Change Password"})]})})})]})})]})]})}):null}export{se as default};
