import{u as e,f as s,r as a,h as r,ai as n,i,j as l,L as d,K as t,B as o,aj as c,a3 as m,aE as u,T as h,a4 as x,a5 as j,a6 as p,a7 as w,a8 as f,a9 as g,aa as v,aF as y,aG as N,aH as b,aI as S,C as E,a as P,b as C,l as F,c as U,ak as A,al as I,am as q,an as T,ao as k,I as D,ap as V,aq as K,ar as L,as as $,at as z,au as B,av as G,aw as Q,ax as O,ay as H,s as J,d as R,az as M,aA as W,aB as X,aC as Y,aD as Z}from"./index-hDnRHjz5.js";const _=M({fullName:Z().min(2,"Full name must be at least 2 characters"),email:Z().email("Email must be a valid email address"),role:Y(["admin","agent","user"]),companyId:X().optional(),isSuperAdmin:W().default(!1)}),ee=M({newPassword:Z().min(6,"Password must be at least 6 characters"),confirmPassword:Z()}).refine((e=>e.newPassword===e.confirmPassword),{message:"Passwords don't match",path:["confirmPassword"]});function se(){var M;const{user:W,isLoading:X}=e(),{toast:Y}=s(),[Z,se]=a.useState(null),[ae,re]=a.useState(!1);a.useEffect((()=>{const e=window.location.pathname,s=parseInt(e.split("/").pop()||"");isNaN(s)||se(s)}),[]),a.useEffect((()=>{X||!W||W.isSuperAdmin||(window.location.href="/")}),[W,X]);const{data:ne,isLoading:ie}=r({queryKey:["/api/admin/users",Z],queryFn:async()=>{if(!Z)throw new Error("User ID is required");const e=await R("GET",`/api/admin/users/${Z}`);if(!e.ok)throw new Error("Failed to fetch user");return e.json()},enabled:!!Z&&!!(null==W?void 0:W.isSuperAdmin)}),{data:le,isLoading:de}=r({queryKey:["/api/admin/companies"],queryFn:async()=>{const e=await R("GET","/api/admin/companies");if(!e.ok)throw new Error("Failed to fetch companies");return e.json()},enabled:!!(null==W?void 0:W.isSuperAdmin)}),te=(null==le?void 0:le.filter((e=>e.active)))||[],oe=n({resolver:H(_),defaultValues:{fullName:"",email:"",role:"agent",isSuperAdmin:!1}}),ce=n({resolver:H(ee),defaultValues:{newPassword:"",confirmPassword:""}});a.useEffect((()=>{ne&&oe.reset({fullName:ne.fullName,email:ne.email,role:ne.role,companyId:ne.companyId||void 0,isSuperAdmin:ne.isSuperAdmin})}),[ne,oe]);const me=i({mutationFn:async e=>{if(!Z)throw new Error("User ID is required");const s=await R("PUT",`/api/admin/users/${Z}`,e);if(!s.ok){const e=await s.json();throw new Error(e.message||"Failed to update user")}return s.json()},onSuccess:()=>{J.invalidateQueries({queryKey:["/api/admin/users"]}),J.invalidateQueries({queryKey:["/api/admin/users",Z]}),Y({title:"User Updated",description:"The user has been updated successfully"})},onError:e=>{Y({title:"Error",description:e.message||"Failed to update user",variant:"destructive"})}}),ue=i({mutationFn:async e=>{if(!Z)throw new Error("User ID is required");const s=await R("POST",`/api/admin/users/${Z}/change-password`,e);if(!s.ok){const e=await s.json();throw new Error(e.message||"Failed to change password")}return s.json()},onSuccess:()=>{ce.reset(),Y({title:"Password Changed",description:"The user's password has been changed successfully"})},onError:e=>{Y({title:"Error",description:e.message||"Failed to change password",variant:"destructive"})}}),he=i({mutationFn:async()=>{if(!Z)throw new Error("User ID is required");const e=await R("DELETE",`/api/admin/users/${Z}`);if(!e.ok){const s=await e.json();throw new Error(s.message||"Failed to delete user")}return e.json()},onSuccess:()=>{J.invalidateQueries({queryKey:["/api/admin/users"]}),Y({title:"User Deleted",description:"The user has been deleted successfully"}),setTimeout((()=>{window.location.href="/admin/users"}),1500)},onError:e=>{Y({title:"Error",description:e.message||"Failed to delete user",variant:"destructive"})}});return X||ie?l.jsx("div",{className:"flex items-center justify-center min-h-screen",children:l.jsx(d,{className:"h-8 w-8 animate-spin text-primary"})}):(null==W?void 0:W.isSuperAdmin)&&ne?l.jsx(t,{children:l.jsxs("div",{className:"p-6",children:[l.jsxs("div",{className:"flex items-center justify-between mb-6",children:[l.jsxs("div",{className:"flex items-center",children:[l.jsxs(o,{variant:"ghost",size:"sm",onClick:()=>window.location.href="/admin/users",className:"mr-4",children:[l.jsx(c,{className:"h-4 w-4 mr-2"}),"Back to Users"]}),l.jsxs("h1",{className:"text-2xl",children:["Edit User: ",ne.fullName]})]}),l.jsxs(m,{open:ae,onOpenChange:re,children:[l.jsx(u,{asChild:!0,children:l.jsxs(o,{variant:"destructive",size:"sm",children:[l.jsx(h,{className:"h-4 w-4 mr-2"}),"Delete User"]})}),l.jsxs(x,{children:[l.jsxs(j,{children:[l.jsx(p,{children:"Are you sure?"}),l.jsx(w,{children:"This action cannot be undone. This will permanently delete the user account and remove their data from our servers."})]}),l.jsxs(f,{children:[l.jsx(g,{children:"Cancel"}),l.jsx(v,{onClick:()=>{he.mutate(),re(!1)},className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Delete"})]})]})]})]}),l.jsxs(y,{defaultValue:"profile",className:"max-w-2xl mx-auto",children:[l.jsxs(N,{className:"grid w-full grid-cols-2",children:[l.jsx(b,{value:"profile",children:"Profile Information"}),l.jsx(b,{value:"security",children:"Security"})]}),l.jsx(S,{value:"profile",children:l.jsxs(E,{children:[l.jsxs(P,{children:[l.jsx(C,{children:"User Profile"}),l.jsx(F,{children:"Update the user's profile information"})]}),l.jsx(U,{children:l.jsx(A,{...oe,children:l.jsxs("form",{onSubmit:oe.handleSubmit((e=>{me.mutate(e)})),className:"space-y-6",children:[l.jsx(I,{control:oe.control,name:"fullName",render:({field:e})=>l.jsxs(q,{children:[l.jsx(T,{children:"Full Name"}),l.jsx(k,{children:l.jsx(D,{placeholder:"John Doe",...e})}),l.jsx(V,{})]})}),l.jsx(I,{control:oe.control,name:"email",render:({field:e})=>l.jsxs(q,{children:[l.jsx(T,{children:"Email"}),l.jsx(k,{children:l.jsx(D,{placeholder:"user@example.com",...e})}),l.jsx(V,{})]})}),l.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[l.jsx(I,{control:oe.control,name:"role",render:({field:e})=>l.jsxs(q,{children:[l.jsx(T,{children:"Role"}),l.jsxs(K,{onValueChange:e.onChange,defaultValue:e.value,children:[l.jsx(k,{children:l.jsx(L,{children:l.jsx($,{placeholder:"Select a role"})})}),l.jsxs(z,{children:[l.jsx(B,{value:"admin",children:"Admin"}),l.jsx(B,{value:"agent",children:"Agent"}),l.jsx(B,{value:"user",children:"User"})]})]}),l.jsx(V,{})]})}),l.jsxs(q,{children:[l.jsx(T,{children:"Company"}),l.jsxs(K,{onValueChange:e=>{oe.setValue("companyId",parseInt(e))},disabled:de||oe.watch("isSuperAdmin"),defaultValue:null==(M=ne.companyId)?void 0:M.toString(),children:[l.jsx(k,{children:l.jsx(L,{children:l.jsx($,{placeholder:"Select a company"})})}),l.jsx(z,{children:te.map((e=>l.jsx(B,{value:e.id.toString(),children:e.name},e.id)))})]}),l.jsx(V,{})]})]}),l.jsx(I,{control:oe.control,name:"isSuperAdmin",render:({field:e})=>l.jsxs(q,{className:"flex flex-row items-center justify-between rounded-lg border p-4",children:[l.jsxs("div",{className:"space-y-0.5",children:[l.jsx(T,{className:"text-base",children:"Super Admin"}),l.jsx(G,{children:"Super admins have access to all system features and settings"})]}),l.jsx(k,{children:l.jsx(Q,{checked:e.value,onCheckedChange:s=>{e.onChange(s),s&&oe.setValue("companyId",void 0)}})})]})}),l.jsx(o,{type:"submit",className:"btn-brand-primary",disabled:me.isPending,children:me.isPending?l.jsxs(l.Fragment,{children:[l.jsx(d,{className:"mr-2 h-4 w-4 animate-spin"}),"Updating User..."]}):l.jsxs(l.Fragment,{children:[l.jsx(O,{className:"mr-2 h-4 w-4"}),"Save Changes"]})})]})})})]})}),l.jsx(S,{value:"security",children:l.jsxs(E,{children:[l.jsxs(P,{children:[l.jsx(C,{children:"Change Password"}),l.jsx(F,{children:"Update the user's password"})]}),l.jsx(U,{children:l.jsx(A,{...ce,children:l.jsxs("form",{onSubmit:ce.handleSubmit((e=>{ue.mutate({newPassword:e.newPassword})})),className:"space-y-6",children:[l.jsx(I,{control:ce.control,name:"newPassword",render:({field:e})=>l.jsxs(q,{children:[l.jsx(T,{children:"New Password"}),l.jsx(k,{children:l.jsx(D,{type:"password",placeholder:"••••••••",...e})}),l.jsx(V,{})]})}),l.jsx(I,{control:ce.control,name:"confirmPassword",render:({field:e})=>l.jsxs(q,{children:[l.jsx(T,{children:"Confirm New Password"}),l.jsx(k,{children:l.jsx(D,{type:"password",placeholder:"••••••••",...e})}),l.jsx(V,{})]})}),l.jsx(o,{type:"submit",className:"btn-brand-primary",disabled:ue.isPending,children:ue.isPending?l.jsxs(l.Fragment,{children:[l.jsx(d,{className:"mr-2 h-4 w-4 animate-spin"}),"Changing Password..."]}):"Change Password"})]})})})]})})]})]})}):null}export{se as default};
