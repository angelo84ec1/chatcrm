import{q as e,r as a,f as s,g as n,h as i,i as l,s as t,d as o,j as c,D as r,t as d,v as m,w as p,T as x,x as h,A as j,y as u,z as y,m as v,L as f,n as N,I as w,E as g,B as b,F as _,M as C,S as k,G as F,H as D,u as S,J as T,K as A,P as L,C as q,a as E,b as M,l as I,c as z,N as P,O as W,Q as $,V as U,W as O,X as K,Y as V,Z as B,_ as G,$ as Y,a0 as Q,a1 as R,a2 as Z,a3 as H,a4 as J,a5 as X,a6 as ee,a7 as ae,a8 as se,a9 as ne,aa as ie}from"./index-Du4k3PvU.js";import{D as le}from"./database-BxMGUDNc.js";const te=e("Files",[["path",{d:"M20 7h-3a2 2 0 0 1-2-2V2",key:"x099mo"}],["path",{d:"M9 18a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h7l4 4v10a2 2 0 0 1-2 2Z",key:"18t6ie"}],["path",{d:"M3 7.6v12.8A1.6 1.6 0 0 0 4.6 22h9.8",key:"1nja0z"}]]);function oe({isOpen:e,onClose:S,companyId:T,companyName:A,onSuccess:L}){const[q,E]=a.useState("preview"),[M,I]=a.useState(""),[z,P]=a.useState(!1),{toast:W}=s(),{t:$}=n();a.useEffect((()=>{e&&(E("preview"),I(""),P(!1))}),[e]);const{data:U,isLoading:O}=i({queryKey:[`/api/admin/companies/${T}/deletion-preview`],queryFn:async()=>{if(!T)throw new Error("No company ID");const e=await o("GET",`/api/admin/companies/${T}/deletion-preview`);if(!e.ok)throw new Error("Failed to fetch deletion preview");return e.json()},enabled:e&&!!T}),K=l({mutationFn:async()=>{if(!T)throw new Error("No company ID");const e=await o("DELETE",`/api/admin/companies/${T}`,{confirmationName:M});if(!e.ok){const a=await e.json();throw new Error(a.error||"Failed to delete company")}return e.json()},onSuccess:e=>{W({title:$("admin.company_deletion.messages.success_title","Company Deleted"),description:e.message}),t.invalidateQueries({queryKey:["/api/admin/companies"]}),L(),S()},onError:e=>{W({title:$("admin.company_deletion.messages.error_title","Deletion Failed"),description:e.message,variant:"destructive"}),P(!1)}}),V=()=>{z||S()};return c.jsx(r,{open:e,onOpenChange:V,children:c.jsxs(d,{className:"sm:max-w-2xl max-h-[90vh] overflow-y-auto",children:[c.jsxs(m,{children:[c.jsxs(p,{className:"flex items-center text-red-600",children:[c.jsx(x,{className:"h-5 w-5 mr-2"}),$("admin.company_deletion.title","Delete Company"),": ",A]}),c.jsxs(h,{children:["preview"===q&&$("admin.company_deletion.steps.preview_description","Review what will be permanently deleted"),"confirm"===q&&$("admin.company_deletion.steps.confirm_description","Confirm the deletion by typing the company name"),"final"===q&&$("admin.company_deletion.steps.final_description","Final confirmation - this action cannot be undone")]})]}),c.jsxs("div",{className:"py-4",children:["preview"===q&&c.jsxs("div",{className:"space-y-4",children:[c.jsxs(j,{className:"border-red-200 bg-red-50",children:[c.jsx(u,{className:"h-4 w-4 text-red-600"}),c.jsx(y,{className:"text-red-800",children:$("admin.company_deletion.preview.warning_title","Warning: Irreversible Action")}),c.jsx(v,{className:"text-red-700",children:$("admin.company_deletion.preview.warning_description","This will permanently delete the company and ALL associated data. This action cannot be undone.")})]}),O?c.jsx("div",{className:"flex justify-center py-8",children:c.jsx(f,{className:"h-8 w-8 animate-spin text-primary"})}):U?c.jsxs("div",{children:[c.jsxs("h4",{className:"font-medium mb-3",children:[$("admin.company_deletion.preview.data_title","Data to be permanently deleted"),":"]}),(()=>{if(!U)return null;const e=[{icon:_,label:$("admin.company_deletion.data_types.users","Users"),count:U.dataToDelete.users,color:"text-blue-600"},{icon:C,label:$("admin.company_deletion.data_types.conversations","Conversations"),count:U.dataToDelete.conversations,color:"text-green-600"},{icon:C,label:$("admin.company_deletion.data_types.messages","Messages"),count:U.dataToDelete.messages,color:"text-green-500"},{icon:le,label:$("admin.company_deletion.data_types.contacts","Contacts"),count:U.dataToDelete.contacts,color:"text-purple-600"},{icon:k,label:$("admin.company_deletion.data_types.flows","Flows"),count:U.dataToDelete.flows,color:"text-orange-600"},{icon:le,label:$("admin.company_deletion.data_types.deals","Deals"),count:U.dataToDelete.deals,color:"text-red-600"},{icon:F,label:$("admin.company_deletion.data_types.payment_records","Payment Records"),count:U.dataToDelete.paymentTransactions,color:"text-yellow-600"},{icon:te,label:$("admin.company_deletion.data_types.media_files","Media Files"),count:U.dataToDelete.estimatedMediaFiles,color:"text-indigo-600"},{icon:k,label:$("admin.company_deletion.data_types.whatsapp_sessions","WhatsApp Sessions"),count:U.dataToDelete.estimatedWhatsappSessions,color:"text-pink-600"}];return c.jsx("div",{className:"grid grid-cols-2 gap-3 mt-4",children:e.map((({icon:e,label:a,count:s,color:n})=>s>0&&c.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[c.jsxs("div",{className:"flex items-center space-x-2",children:[c.jsx(e,{className:`h-4 w-4 ${n}`}),c.jsx("span",{className:"text-sm font-medium",children:a})]}),c.jsx(D,{variant:"outline",className:"text-xs",children:s.toLocaleString()})]},a)))})})(),U.warnings.length>0&&c.jsxs("div",{className:"mt-4",children:[c.jsxs("h4",{className:"font-medium mb-2 text-red-800",children:[$("admin.company_deletion.preview.warnings_title","Critical Warnings"),":"]}),c.jsx("ul",{className:"space-y-1",children:U.warnings.map(((e,a)=>c.jsxs("li",{className:"text-sm text-red-700 flex items-start",children:[c.jsx(u,{className:"h-3 w-3 mr-2 mt-0.5 flex-shrink-0"}),e]},a)))})]})]}):c.jsx("div",{className:"text-center py-4 text-red-600",children:$("admin.company_deletion.preview.load_error","Failed to load deletion preview")})]}),"confirm"===q&&c.jsxs("div",{className:"space-y-4",children:[c.jsxs(j,{className:"border-red-200 bg-red-50",children:[c.jsx(u,{className:"h-4 w-4 text-red-600"}),c.jsx(y,{className:"text-red-800",children:$("admin.company_deletion.confirm.title","Type Company Name to Continue")}),c.jsxs(v,{className:"text-red-700",children:[$("admin.company_deletion.confirm.description","To confirm deletion, type the exact company name"),": ",c.jsx("strong",{children:A})]})]}),c.jsxs("div",{className:"space-y-2",children:[c.jsx(N,{htmlFor:"confirmationName",children:$("admin.company_deletion.confirm.label","Company Name")}),c.jsx(w,{id:"confirmationName",value:M,onChange:e=>I(e.target.value),placeholder:$("admin.company_deletion.confirm.placeholder",'Type "{{name}}" to confirm',{name:A}),className:"border-red-300 focus:border-red-500"})]})]}),"final"===q&&c.jsxs("div",{className:"space-y-4",children:[c.jsxs(j,{className:"border-red-200 bg-red-50",children:[c.jsx(u,{className:"h-4 w-4 text-red-600"}),c.jsx(y,{className:"text-red-800",children:$("admin.company_deletion.final.title","Final Confirmation")}),c.jsx(v,{className:"text-red-700",children:$("admin.company_deletion.final.description","You are about to permanently delete {{name}} and all its data. This action is irreversible and will immediately remove all associated information.",{name:A})})]}),c.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[c.jsxs("h4",{className:"font-medium mb-2",children:[$("admin.company_deletion.final.consequences_title","What happens next"),":"]}),c.jsxs("ul",{className:"text-sm space-y-1 text-gray-700",children:[c.jsxs("li",{children:["• ",$("admin.company_deletion.final.consequence_users","All user accounts will be deleted")]}),c.jsxs("li",{children:["• ",$("admin.company_deletion.final.consequence_conversations","All conversations and messages will be removed")]}),c.jsxs("li",{children:["• ",$("admin.company_deletion.final.consequence_contacts","All contacts and their data will be deleted")]}),c.jsxs("li",{children:["• ",$("admin.company_deletion.final.consequence_media","All media files will be permanently removed")]}),c.jsxs("li",{children:["• ",$("admin.company_deletion.final.consequence_whatsapp","All WhatsApp sessions will be terminated")]}),c.jsxs("li",{children:["• ",$("admin.company_deletion.final.consequence_payments","All payment records will be deleted")]}),c.jsxs("li",{children:["• ",$("admin.company_deletion.final.consequence_company","The company will be completely removed from the system")]})]})]})]})]}),c.jsxs(g,{className:"flex justify-between",children:[c.jsx(b,{variant:"outline",onClick:V,disabled:z,children:$("common.cancel","Cancel")}),c.jsxs("div",{className:"flex space-x-2",children:["preview"===q&&c.jsx(b,{variant:"destructive",onClick:()=>E("confirm"),disabled:!U,children:$("admin.company_deletion.buttons.continue_to_confirmation","Continue to Confirmation")}),"confirm"===q&&c.jsxs(c.Fragment,{children:[c.jsx(b,{variant:"outline",onClick:()=>E("preview"),disabled:z,children:$("common.back","Back")}),c.jsx(b,{variant:"destructive",onClick:()=>E("final"),disabled:M!==A,children:$("admin.company_deletion.buttons.proceed_to_final","Proceed to Final Step")})]}),"final"===q&&c.jsxs(c.Fragment,{children:[c.jsx(b,{variant:"outline",onClick:()=>E("confirm"),disabled:z,children:$("common.back","Back")}),c.jsx(b,{variant:"destructive",onClick:()=>{P(!0),K.mutate()},disabled:z,className:"bg-red-600 hover:bg-red-700",children:z?c.jsxs(c.Fragment,{children:[c.jsx(f,{className:"mr-2 h-4 w-4 animate-spin"}),$("admin.company_deletion.buttons.deleting","Deleting...")]}):c.jsxs(c.Fragment,{children:[c.jsx(x,{className:"mr-2 h-4 w-4"}),$("admin.company_deletion.buttons.delete_permanently","Delete Company Permanently")]})})]})]})]})]})})}function ce(){const{user:e,isLoading:s,impersonateCompanyMutation:n}=S(),{plans:l,isLoading:t}=T(),[r,d]=a.useState(""),[m,p]=a.useState(null),[h,j]=a.useState(null),[u,y]=a.useState(!1);a.useEffect((()=>{s||!e||e.isSuperAdmin||(window.location.href="/")}),[e,s]);const{data:v,isLoading:N}=i({queryKey:["/api/admin/companies"],queryFn:async()=>{const e=await o("GET","/api/admin/companies");if(!e.ok)throw new Error("Failed to fetch companies");return e.json()},enabled:!!(null==e?void 0:e.isSuperAdmin)}),g=e=>l.find((a=>a.name.toLowerCase()===e.toLowerCase())),_=null==v?void 0:v.filter((e=>e.name.toLowerCase().includes(r.toLowerCase())||e.slug.toLowerCase().includes(r.toLowerCase())||e.plan.toLowerCase().includes(r.toLowerCase())));return s?c.jsx("div",{className:"flex items-center justify-center min-h-screen",children:c.jsx(f,{className:"h-8 w-8 animate-spin text-primary"})}):(null==e?void 0:e.isSuperAdmin)?c.jsx(A,{children:c.jsxs("div",{className:"p-6",children:[c.jsxs("div",{className:"flex justify-between items-center mb-6",children:[c.jsx("h1",{className:"text-2xl",children:"Companies"}),c.jsxs(b,{onClick:()=>window.location.href="/admin/companies/new",variant:"brand",className:"btn-brand-primary",children:[c.jsx(L,{className:"mr-2 h-4 w-4"}),"New Company"]})]}),c.jsxs(q,{className:"mb-6",children:[c.jsxs(E,{children:[c.jsx(M,{children:"Manage Companies"}),c.jsx(I,{children:"View and manage all companies in the system"})]}),c.jsxs(z,{children:[c.jsx("div",{className:"flex items-center mb-4",children:c.jsxs("div",{className:"relative flex-1",children:[c.jsx(P,{className:"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground"}),c.jsx(w,{placeholder:"Search companies...",className:"pl-8",value:r,onChange:e=>d(e.target.value)})]})}),N?c.jsx("div",{className:"flex justify-center py-8",children:c.jsx(f,{className:"h-8 w-8 animate-spin text-primary"})}):0===(null==_?void 0:_.length)?c.jsx("div",{className:"text-center py-8 text-muted-foreground",children:r?"No companies match your search":"No companies found. Create your first company to get started."}):c.jsx("div",{className:"rounded-md border",children:c.jsxs(W,{children:[c.jsx($,{children:c.jsxs(U,{children:[c.jsx(O,{children:"Name"}),c.jsx(O,{children:"Slug"}),c.jsx(O,{children:"Plan"}),c.jsx(O,{children:"Users"}),c.jsx(O,{children:"Status"}),c.jsx(O,{children:"Actions"})]})}),c.jsx(K,{children:null==_?void 0:_.map((e=>{var a,s,n,i,l,o,r;return c.jsxs(U,{children:[c.jsx(V,{className:"font-medium",children:e.name}),c.jsx(V,{className:"text-muted-foreground",children:e.slug}),c.jsx(V,{children:c.jsxs("div",{className:"flex items-center",children:[c.jsx("span",{className:"capitalize font-medium",children:e.plan}),c.jsx(B,{children:c.jsxs(G,{children:[c.jsx(Y,{asChild:!0,children:c.jsx(b,{variant:"ghost",size:"icon",className:"h-6 w-6 ml-1",children:c.jsx(Q,{className:"h-3.5 w-3.5 text-muted-foreground"})})}),c.jsx(R,{side:"right",className:"max-w-xs",children:t?c.jsxs("div",{className:"flex items-center",children:[c.jsx(f,{className:"h-3 w-3 animate-spin mr-2"}),"Loading plan details..."]}):c.jsxs("div",{className:"space-y-1 text-xs",children:[c.jsx("p",{className:"font-semibold",children:(null==(a=g(e.plan))?void 0:a.name)||e.plan}),c.jsx("p",{children:(null==(s=g(e.plan))?void 0:s.description)||"No description available"}),c.jsxs("div",{className:"mt-1 pt-1 border-t border-border",children:[c.jsxs("p",{children:[c.jsx("span",{className:"font-medium",children:"Price:"})," $",(null==(n=g(e.plan))?void 0:n.price)||0,"/month"]}),c.jsxs("p",{children:[c.jsx("span",{className:"font-medium",children:"Max Users:"})," ",(null==(i=g(e.plan))?void 0:i.maxUsers)||e.maxUsers]}),c.jsxs("p",{children:[c.jsx("span",{className:"font-medium",children:"Max Contacts:"})," ",(null==(o=null==(l=g(e.plan))?void 0:l.maxContacts)?void 0:o.toLocaleString())||"N/A"]}),c.jsxs("p",{children:[c.jsx("span",{className:"font-medium",children:"Max Channels:"})," ",(null==(r=g(e.plan))?void 0:r.maxChannels)||"N/A"]})]})]})})]})})]})}),c.jsx(V,{children:e.maxUsers}),c.jsx(V,{children:e.active?c.jsx(D,{className:"bg-green-100 text-green-800 hover:bg-green-100",children:"Active"}):c.jsx(D,{variant:"outline",className:"bg-gray-100 text-gray-800 hover:bg-gray-100",children:"Inactive"})}),c.jsx(V,{children:c.jsxs("div",{className:"flex space-x-2",children:[c.jsx(b,{variant:"brand",size:"sm",onClick:()=>window.location.href=`/admin/companies/${e.id}`,children:"Manage"}),c.jsxs(b,{className:"btn-brand-primary",variant:"secondary",size:"sm",onClick:()=>(e=>{p(e)})(e),children:[c.jsx(Z,{className:"h-3.5 w-3.5 mr-1"}),"Login As"]}),"system"!==e.slug&&c.jsxs(b,{variant:"destructive",size:"sm",onClick:()=>(e=>{"system"!==e.slug&&(j(e),y(!0))})(e),className:"bg-red-600 hover:bg-red-700",children:[c.jsx(x,{className:"h-3.5 w-3.5 mr-1"}),"Delete"]})]})})]},e.id)}))})]})})]})]}),c.jsx(H,{open:!!m,onOpenChange:e=>!e&&p(null),children:c.jsxs(J,{className:"max-w-md max-h-[90vh]",children:[c.jsxs(X,{children:[c.jsx(ee,{children:"Impersonate Company"}),c.jsxs(ae,{children:["You are about to log in as an admin user for ",null==m?void 0:m.name,". This will allow you to access the company dashboard and perform actions as a company admin."]})]}),c.jsxs(se,{className:"mt-4",children:[c.jsx(ne,{children:"Cancel"}),c.jsx(ie,{className:"btn-brand-primary",onClick:()=>{m&&(n.mutate(m.id),p(null))},children:n.isPending?c.jsxs(c.Fragment,{children:[c.jsx(f,{className:"h-4 w-4 mr-2 animate-spin"}),"Impersonating..."]}):c.jsxs(c.Fragment,{children:[c.jsx(Z,{className:"h-4 w-4 mr-2"}),"Login as Company Admin"]})})]})]})}),c.jsx(oe,{isOpen:u,onClose:()=>{y(!1),j(null)},companyId:(null==h?void 0:h.id)||null,companyName:(null==h?void 0:h.name)||"",onSuccess:()=>{j(null),y(!1)}})]})}):null}export{ce as default};
